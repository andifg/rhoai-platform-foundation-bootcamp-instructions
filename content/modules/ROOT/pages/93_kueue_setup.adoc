= Lab Guide: Advanced GPU Quota Management and Preemption with Kueue
:icons: font
:stem: latexmath
:icons: font
:toc: left
:source-highlighter: highlight.js
:numbered:

== Prerequisites

1.  **OpenShift AI Operator:** Ensure the OpenShift AI Operator is installed on your cluster.
2.  **GPU Worker Node:** You need at least one worker node with a minimum of 1 GPU. On AWS, a `g5.2xlarge` instance or similar is suitable.
3.  **GPU Node Taint:** The GPU node must be tainted to ensure only GPU-tolerant workloads are scheduled on it.

[NOTE]
====
This was already done during the bootstrap process in the previous lab. If you need to reapply the taint, use the following command, replacing `<your-gpu-node-name>` with the actual name of your GPU node.

[.console-input]
[source,bash]
----
oc adm taint nodes <your-gpu-node-name> nvidia.com/gpu=Exists:NoSchedule
----

====

== Install Red Hat build of Kueue Operator
Install the https://docs.redhat.com/en/documentation/red_hat_build_of_kueue/1.0[Red Hat build of Kueue Operator].


[NOTE]
====
Note that the snippets in following section always starts with `cat <<EOF | oc apply -f -` and end with `EOF` line. 

Copying everything from the snippet to the terminal will apply the content, without a need to create actual yaml file on your localhost. +
If you want to save these, actual yaml files do not need above mentioned lines, so make sure to remove them.

.Snippet with yaml file content
[%collapsible]
=====
[source,bash]
----
cat <<EOF | oc apply -f -
<actual-yaml-file-content>
EOF
----
=====
====

1. Create a new file named `kueue-namespace.yaml` with the following content to create the `openshift-kueue-operator` namespace with monitoring enabled:
+
[.console-input]
[source,bash]
----
cat <<EOF | oc apply -f -
apiVersion: v1
kind: Namespace
metadata:
  name: openshift-kueue-operator
  annotations:
    openshift.io/description: "openshift-kueue-operator"
    openshift.io/display-name: "openshift-kueue-operator"
    openshift.io/requester: ""
  labels:
    openshift.io/cluster-monitoring: "true"
spec:
  finalizers:
    - kubernetes
EOF
----

2. Create a new file named `kueue-operator.yaml` with the following content to create the `kueue-operator.yaml` operator subscription:
+
[.console-input]
[source,bash]
----
cat <<EOF | kubectl apply -f -
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  labels:
    operators.coreos.com/kueue-operator.openshift-kueue-operator: ""
  name: kueue-operator
  namespace: openshift-kueue-operator
spec:
  channel: stable-v1.0
  installPlanApproval: Automatic
  name: kueue-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace
  startingCSV: kueue-operator.v1.0.1
EOF
----

3. Now create a new file `kueue-operator-group.yaml` with the following content to create an OperatorGroup for the Kueue operator:
+
[.console-input]
[source,bash]
----
cat <<EOF | kubectl apply -f -
apiVersion: operators.coreos.com/v1
kind: OperatorGroup
metadata:
  annotations:
    olm.providedAPIs: Kueue.v1.kueue.openshift.io
  name: openshift-kueue-operator
  namespace: openshift-kueue-operator
spec:
  upgradeStrategy: Default
status:
  namespaces:
  - ""
EOF
----

4. Wait for the Kueue operator to be fully deployed. You can check the status of the operator pod:
+
[.console-input]
[source,bash]
----
oc get pods -n openshift-kueue-operator -w
----
+
You should see an output similar to this:
+
[source,text]
----
NAME                                   READY   STATUS    RESTARTS   AGE
kueue-controller-xxxxxx-yyyyy            1/1     Running   0          2m
----

5. Create a new file named `kueue-cluster.yaml` with the following content to set up the Kueue environment, including namespaces, priority classes, resource flavors, cluster queues, and local queues:
+
[.console-input]
[source,bash]
----
cat <<EOF | kubectl apply -f -
apiVersion: kueue.openshift.io/v1
kind: Kueue
metadata:
  labels:
    app.kubernetes.io/name: kueue-operator
    app.kubernetes.io/managed-by: kustomize
  name: cluster
  namespace: openshift-kueue-operator
spec:
  managementState: Managed
  config:
    integrations:
      frameworks:
      - BatchJob
    preemption:
      preemptionPolicy: FairSharing
EOF
----

After this step the Red Hat build of Kueue is installed and running in your cluster. You can verify that the Kueue operator in the Web Console by navigating to the installed operators.

[.bordershadow]
image::RHBoKCluster.png[]

== Install Kueue Vizualization
[CAUTION]
.The Operator does not have a Dashboard yet
====
Some might experience Websocket issues
====

First apply the following configuration:

[.console-input]
[source,yaml]
----
kind: Project
apiVersion: project.openshift.io/v1
metadata:
  name: kueue-system
spec:
  finalizers:
    - kubernetes
status:
  phase: Active
---
# Source: kueue/templates/kueueviz/clusterrole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: 'kueue-kueueviz-backend-read-access'
  namespace: 'kueue-system'
rules:
  - apiGroups: ["kueue.x-k8s.io"]
    resources: ["workloads", "clusterqueues", "localqueues", "resourceflavors"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods", "events", "nodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["kueue.x-k8s.io"]
    resources: ["workloadpriorityclass"]
    verbs: ["get", "list", "watch"]
---
# Source: kueue/templates/kueueviz/cluster-role-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: 'kueue-kueueviz-backend-read-access-binding'
  namespace: 'kueue-system'
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: 'kueue-kueueviz-backend-read-access'
subjects:
  - kind: ServiceAccount
    name: default
    namespace: 'kueue-system'
---
# Source: kueue/templates/kueueviz/backend-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: 'kueue-kueueviz-backend'
  namespace: 'kueue-system'
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
  selector:
    app: kueueviz-backend
---
# Source: kueue/templates/kueueviz/frontend-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: 'kueue-kueueviz-frontend'
  namespace: 'kueue-system'
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: 8080
  selector:
    app: kueueviz-frontend
---
# Source: kueue/templates/kueueviz/backend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: 'kueue-kueueviz-backend'
  namespace: 'kueue-system'
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kueueviz-backend
  template:
    metadata:
      labels:
        app: kueueviz-backend
    spec:
      containers:
        - name: backend
          image: 'registry.k8s.io/kueue/kueueviz-backend:v0.13.4'
          imagePullPolicy: 'IfNotPresent'
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 500m
              memory: 512Mi
---
# Source: kueue/templates/kueueviz/frontend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: 'kueue-kueueviz-frontend'
  namespace: 'kueue-system'
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kueueviz-frontend
  template:
    metadata:
      labels:
        app: kueueviz-frontend
    spec:
      containers:
        - name: frontend
          image: 'registry.k8s.io/kueue/kueueviz-frontend:v0.13.4'
          imagePullPolicy: 'IfNotPresent'
          ports:
            - containerPort: 8080
          env:
            - name: REACT_APP_WEBSOCKET_URL
              value: 'wss://backend.kueueviz.local'
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 500m
              memory: 512Mi
----

[.console-input]
[source,bash]
----
kubectl -n kueue-system port-forward svc/kueue-kueueviz-backend 8080:8080 &
kubectl -n kueue-system set env deployment kueue-kueueviz-frontend REACT_APP_WEBSOCKET_URL=ws://localhost:8080
kubectl -n kueue-system port-forward svc/kueue-kueueviz-frontend 3000:8080
----

Open http://localhost:3000/[http://localhost:3000/] in the browser.

[bibliography]
== References

* [[[kueue-docs, 1]]] Kueue. _Documentation_. Version May 15, 2025. Available from: https://kueue.sigs.k8s.io/docs/overview/.
* [[[repo, 2]]] AI on OpenShift Contrib Repo. _Kueue Preemption Example_. Available from: https://github.com/opendatahub-io-contrib/ai-on-openshift.